# Metagenomic NGS Analysis

Author: Rhoda Leung | *Bash script for processing Nanopore raw data to generate Kraken2 and Bracken reports for metagenomic analysis.*
Second edit of this README file: Aixin LI (2025-08-19)

---


## Script path

Since the script is for in-group use, you can get the script in CVVT server using command below:

```bash
cp /home/kelvinto/kelvinto/aixin/00.Data/01.Rhoda_mNGS_pipeline/* <your/working/directory>
```

---

### üöÄ Usage

you can modify the ```work.sh``` and run ```nohup bash work.sh```

**Content of ```work.sh```**: 

```bash
bash ./mNGS_analysis.sh --start_bc 05 --end_bc 07 --raw_dir "20250401_1617_MN33269_FBB43311_bef60500,20230416_1520_MN34403_FAY26260_255430c4" --csv sample_template.csv
```

---

## üìÑ CSV File Format

**Example `sample_template.csv`**:
```csv
barcode,sample_name
05,SampleA
06,SampleB
07,SampleC
```

The script uses these sample names to prefix Kraken2 and Bracken reports (e.g., `SampleA_nohuman_barcode05.ppf.0.0.kraken2_report`).

---

## üìÇ Output

The script creates an output directory named `<data_hps>hps` (e.g., `48hps`) containing:

- **Kraken2 Reports**: `kraken2/<cs>/*.kraken2_report` (and `filtered_<length>` for filtered reads).
- **Bracken Reports**: `bracken/<cs>/*.bracken_report` (renamed from `*_bracken_species.kraken2_report`).
- **Intermediate Files**: Moved to `intermediate_files/` (e.g., `*.ppf.*.*.bracken`).
- **Log File**: `metagenomics_analysis_<timestamp>.log` with detailed execution logs.
- **FASTQ Files**: `nohuman_barcodeXX.fastq.gz` (after human read removal) and filtered versions if `--filter_seq` is used.

*Note*: Kraken2 output files (e.g., `*.kraken2_output.gz`) are not renamed and remain in `kraken2/<cs>/`.

---

## ‚ÑπÔ∏è Notes

<details>
<summary>View Notes</summary>

- **Barcode Format**: Barcodes in `--start_bc`, `--end_bc`, and the CSV file must be two-digit numbers with leading zeros (e.g., `05`, not `5`).
- **Kraken2 Server**: Ensure `run_kraken2-server.sh` is present, as it is copied to the output directory and used for Kraken2 analysis.
- **Validation**: The script checks that `--start_bc` and `--end_bc` are two-digit numbers between `01` and `99`, and that `--start_bc` is not greater than `--end_bc`.
- **No sample CSV**: If no CSV file is provided, reports retain their original names (e.g., `nohuman_barcode05.ppf.0.0.kraken2_report`).
- **MinKNOW Version**: The script expects Nanopore data generated by MinKNOW version 24.11.8 to ensure compatibility with the no_sample_id/*/fastq_pass/barcodeXX directory raw data structure.
- **Bracken Reports**: `bracken/<cs>/*_bracken_species.kraken2_report` (prefixed with sample names from CSV if provided).
- **Dependency Versions**: Verify your system‚Äôs dependency versions match those listed (see [Dependency Versions](#dependency-versions)).

</details>

---

## üì¨ Contact

For issues or questions, contact **Rhoda Leung** or open an issue on the [GitHub repository](https://github.com/your-repo/mNGS_analysis).
